<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>UnderDark ダメージ計算機（ツリー表示＋条件半透明）</title>

<style>
:root{
  --bg:#0f1115;
  --card:#171a21;
  --panel:#0f1218;
  --text:#e7e7ea;
  --muted:#a9acb6;
  --line:#262a33;
  --line2:#2a2f3a;
  --acc:#7aa2ff;
  --warn:#ffcf7a;

  --c-base:#e7e7ea;
  --c-ab:#d7dbe6;

  --c-stun:#8fb1ff;
  --c-slow:#7be0ff;
  --c-bleed:#ff7b86;
  --c-poison:#7dffb0;
  --c-burn:#ffb86b;
  --c-immune:#c7a6ff;
  --c-flying:#ffd36e;

  --c-mondmg:#b7ffda;
  --c-pick:#9ee7ff;
  --c-heroatk:#ffd0ff;
}

*{ box-sizing:border-box; }
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif;
  background:var(--bg);
  color:var(--text);
  word-break: normal;
  overflow-wrap: anywhere;
}

.wrap{ max-width:1100px; margin:0 auto; padding:16px; }
.top{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
h1{ font-size:18px; margin:0; }

.tag{
  border:1px solid var(--line2);
  border-radius:999px;
  padding:3px 9px;
  font-size:12px;
  color:var(--acc);
  background:rgba(122,162,255,0.06);
}

.grid{ display:grid; gap:12px; align-items:start; }
@media(min-width:920px){ .grid{ grid-template-columns:1fr 1fr; } }

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:14px;
  padding:14px;
  box-shadow:0 0 0 1px rgba(0,0,0,0.12) inset;
}

.row{
  display:grid;
  grid-template-columns:minmax(180px,1fr) minmax(220px,360px);
  gap:10px;
  margin:10px 0;
  align-items:center;
}
@media(max-width:720px){ .row{ grid-template-columns:1fr; } }

label{ font-size:13px; color:var(--muted); line-height:1.4; }

input, select{
  width:100%;
  padding:10px 11px;
  border-radius:10px;
  border:1px solid var(--line2);
  background:var(--panel);
  color:var(--text);
  outline:none;
}
input:focus, select:focus{ border-color:#3a4252; }

.small{ font-size:12px; color:var(--muted); }
.mono{ font-family:ui-monospace,Menlo,Consolas,monospace; }

/* ATK unit input group */
.inputGroup{
  display:flex;
  gap:8px;
  align-items:center;
}
.inputGroup .unitSelect{
  width:110px;
  flex:0 0 auto;
}
@media(max-width:720px){
  .inputGroup{ flex-wrap:wrap; }
  .inputGroup .unitSelect{ width:140px; }
}

.checkGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:8px;
}
@media(max-width:720px){ .checkGrid{ grid-template-columns:1fr; } }

.checkItem{
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:var(--panel);
  display:flex;
  align-items:center;
  min-height:48px;
}
.checkRow{
  display:flex;
  align-items:flex-start;
  gap:6px;
  width:100%;
}
input.ab,input.cond{
  width:auto;
  margin:0;
  flex:0 0 auto;
  margin-top:2px;
}
.checkText{
  cursor:pointer;
  user-select:none;
  color:var(--text);
  font-size:13px;
  line-height:1.25;
  white-space:normal;
  overflow-wrap:anywhere;
}

.kpi{ display:grid; gap:10px; }
@media(min-width:920px){ .kpi{ grid-template-columns:1fr 1fr; } }
@media(max-width:720px){ .kpi{ grid-template-columns:1fr; } }

.box{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px;
  min-height:92px;
}
.v{ font-size:22px; margin-top:6px; }
.note{
  margin-top:6px;
  font-size:12px;
  color:var(--warn);
  line-height:1.35;
}
.note.muted{ color:var(--muted); }

/* ---------- details base ---------- */
details{
  margin-top:12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:var(--panel);
  padding:10px 12px;
  transition: opacity .15s ease;
}
details.isDim{ opacity:.45; }

/* 条件OFF時は操作不可（誤入力防止） */
details.isDisabled{ pointer-events:none; }
details.isDisabled summary{ cursor:not-allowed; opacity:.75; }

summary{
  cursor:pointer;
  color:var(--acc);
  font-size:13px;
  list-style:none;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
summary::-webkit-details-marker{ display:none; }

.badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid var(--line2);
  font-size:12px;
  color:var(--muted);
}

.dimNote{
  display:none;
  font-size:12px;
  color:var(--warn);
  margin-top:6px;
}
details.isDim .dimNote{ display:block; }
details.isDisabled .dimNote{ display:block; }

.btnRow{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
}
button{
  padding:9px 10px;
  border-radius:10px;
  border:1px solid var(--line2);
  background:#101420;
  color:var(--text);
  cursor:pointer;
}
button:hover{ border-color:#3a4252; }

.stack{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
.entryItem{
  display:grid;
  grid-template-columns:1fr 140px 80px;
  gap:8px;
  align-items:center;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:rgba(0,0,0,0.18);
}
@media(max-width:720px){ .entryItem{ grid-template-columns:1fr; } }

pre{
  margin-top:8px;
  padding:10px;
  background:#0b0e13;
  border:1px solid var(--line);
  border-radius:10px;
  font-size:12px;
  white-space:pre-wrap;
  overflow-wrap:anywhere;
}

/* ---------- tree colors ---------- */
.t-base{ color:var(--c-base); }
.t-ab{ color:var(--c-ab); }
.t-stun{ color:var(--c-stun); }
.t-slow{ color:var(--c-slow); }
.t-bleed{ color:var(--c-bleed); }
.t-poison{ color:var(--c-poison); }
.t-burn{ color:var(--c-burn); }
.t-immune{ color:var(--c-immune); }
.t-flying{ color:var(--c-flying); }
.t-mondmg{ color:var(--c-mondmg); }
.t-pick{ color:var(--c-pick); }
.t-heroatk{ color:var(--c-heroatk); }
.t-dim{ color:rgba(231,231,234,0.55); }

.seg{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
.seg button{ background:rgba(255,255,255,0.02); }
.seg button.active{
  border-color:#3a4252;
  background:rgba(122,162,255,0.10);
}
.copyRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
.toast{ margin-top:8px; font-size:12px; color:var(--muted); }

/* ---------- tooltip ---------- */
.labelRow{
  display:flex;
  align-items:flex-start;
  gap:8px;
}
.tip{
  position:relative;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:18px;
  height:18px;
  border-radius:999px;
  border:1px solid var(--line2);
  background:rgba(255,255,255,0.03);
  color:var(--muted);
  font-size:12px;
  line-height:1;
  cursor:help;
  flex:0 0 auto;
  margin-top:1px;
}
.tip:focus{ outline:none; border-color:#3a4252; }

.tipBox{
  position:absolute;
  left:0;
  top:22px;
  z-index:50;
  width:min(320px, 72vw);
  padding:10px 10px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#0b0e13;
  color:var(--text);
  font-size:12px;
  line-height:1.5;
  box-shadow:0 10px 30px rgba(0,0,0,0.45);
  display:none;
}
.tipBox b{ color:var(--acc); font-weight:600; }
.tipBox .muted{ color:var(--muted); }
.tip:hover .tipBox,
.tip:focus .tipBox,
.tip.isOpen .tipBox{
  display:block;
}

/* ---------- Accordion blocks ---------- */
details.accordion{
  margin-top:0;
  padding:0;
  background:transparent;
  border:0;
}
details.accordion + details.accordion{ margin-top:12px; }

details.accordion > summary{
  color:var(--text);
  font-size:14px;
  background:rgba(255,255,255,0.03);
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px 12px;
}
details.accordion > summary .mini{
  color:var(--muted);
  font-size:12px;
}
details.accordion > summary .chev{
  color:var(--muted);
  font-size:12px;
}
details.accordion .accBody{
  margin-top:10px;
}

/* 内側のdetails */
.innerDetails{ margin-top:10px; }
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <h1>ダメージ計算機</h1>
  </div>

  <div class="grid">
    <div class="card">

      <!-- ★ 英雄（基本情報の上） -->
      <details class="accordion" open>
        <summary>
          <span>英雄</span>
          <span class="mini">選択・レベル</span>
          <span class="chev">▼</span>
        </summary>
        <div class="accBody">

          <div class="row">
            <label>英雄</label>
            <select id="heroSelect">
              <option value="">（未選択）</option>
              <option value="thor">トール</option>
              <option value="anubis">アヌビス</option>
              <option value="plague_doctor">疫病医</option>
              <option value="bear_salmon">サーモンを食べる熊</option>
              <option value="other">その他</option>
            </select>
          </div>

          <div class="row">
            <label>レベル</label>
            <select id="heroLevel">
              <option value="">（未選択）</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="12+">12以上</option>
            </select>
            <div class="small" style="margin-top:6px;">
              ※今は表示・保存のみ（計算ロジックには未反映）
            </div>
          </div>

        </div>
      </details>

      <!-- 基本情報 Accordion -->
      <details class="accordion" open>
        <summary>
          <span>基本情報</span>
          <span class="mini">攻撃力・クリティカル</span>
          <span class="chev">▼</span>
        </summary>
        <div class="accBody">

          <div class="row">
            <label>
              <div class="labelRow">
                <span>攻撃力（ATK）</span>
                <span class="tip" tabindex="0" role="button" aria-label="攻撃力（ATK）の説明">
                  ⓘ
                  <span class="tipBox">
                    <b>攻撃力（ATK）</b><br>
                    入力欄の右で <b>K/M/B/T/Qa/Qi/E</b> を選べます。<br>
                    <span class="muted">例：20 + K → 20,000</span><br>
                    <span class="muted">未入力の場合は 0 扱い。</span>
                  </span>
                </span>
              </div>
            </label>

            <div class="inputGroup">
              <input id="atk" type="number" value="" placeholder="未入力なら0" min="0" step="1">
              <select id="atkUnit" class="unitSelect" aria-label="ATK単位">
                <option value="1">（なし）</option>
                <option value="1e3">K</option>
                <option value="1e6">M</option>
                <option value="1e9">B</option>
                <option value="1e12">T</option>
                <option value="1e15">Qa</option>
                <option value="1e18">Qi</option>
                <option value="1e18">E</option>
              </select>
            </div>
            <div class="small" style="margin-top:6px;">
              ※ E は 10^18 として扱います（Qi も同じ倍率）
            </div>
          </div>

          <div class="row">
            <label>
              <div class="labelRow">
                <span>英雄の攻撃力 50%増加 × 回数</span>
                <span class="tip" tabindex="0" role="button" aria-label="英雄の攻撃力50%増加×回数の説明">
                  ⓘ
                  <span class="tipBox">
                    <b>英雄の攻撃力 50%増加 × 回数</b><br>
                    1回につき<b>攻撃力が +50%</b>される想定で、<b>ATKに乗算</b>します。<br>
                    <span class="muted">倍率 = 1 + 0.5 × 回数</span>
                  </span>
                </span>
              </div>
            </label>
            <input id="heroAtk50Count" type="number" value="" placeholder="未入力なら0" min="0" step="1">
          </div>

          <div class="row">
            <label>
              <div class="labelRow">
                <span>クリティカル率（%）</span>
                <span class="tip" tabindex="0" role="button" aria-label="クリティカル率（%）の説明">
                  ⓘ
                  <span class="tipBox">
                    <b>クリティカル率（%）</b><br>
                    <b>ダンジョン入場以降</b>のステータス記載の<b>クリティカル率</b>を入力してください。<br>
                    <span class="muted">0〜100の範囲で入力。</span>
                  </span>
                </span>
              </div>
            </label>
            <input id="cr" type="number" value="" placeholder="未入力なら0" min="0" max="100" step="0.1">
          </div>

          <div class="row">
            <label>
              <div class="labelRow">
                <span>クリティカルダメージ（%）<br><span class="small">例：+1012% → 1012</span></span>
                <span class="tip" tabindex="0" role="button" aria-label="クリティカルダメージ（%）の説明">
                  ⓘ
                  <span class="tipBox">
                    <b>クリティカルダメージ（%）</b><br>
                    <b>ダンジョン入場以降</b>のステータス記載の<b>クリティカルダメージ</b>を入力してください。<br>
                    <span class="muted">例：+1012% → 1012</span>
                  </span>
                </span>
              </div>
            </label>
            <input id="cd" type="number" value="" placeholder="未入力なら0" min="0" step="0.1">
          </div>

          <div class="row">
            <label>モンスターが受けるダメージが増加（%）<br><span class="small">例：400% → 400（= 5.0倍）</span></label>
            <input id="monDmg" type="number" value="" placeholder="未入力なら0" min="0" step="1">
          </div>

        </div>
      </details>

      <!-- ツルハシ Accordion -->
      <details class="accordion" open>
        <summary>
          <span>ツルハシ</span>
          <span class="mini">所持数 × X% だけ全体ATK増加（ATKに乗算）</span>
          <span class="chev">▼</span>
        </summary>
        <div class="accBody">

          <div class="row">
            <label>ツルハシの所持数</label>
            <input id="pickCount" type="number" value="" placeholder="未入力なら0" min="0" step="1">
          </div>

          <div class="row">
            <label>タワーリストにあるツルハシの数だけX％全体の攻撃力増加<br><span class="small">X（% / 1本）</span></label>
            <input id="pickPct" type="number" value="" placeholder="未入力なら0" min="0" step="0.1">
          </div>

        </div>
      </details>

      <!-- 状態異常 Accordion -->
      <details class="accordion" open>
        <summary>
          <span>状態異常</span>
          <span class="mini">※免疫は状態異常数に含めない / リスト表示もしない</span>
          <span class="chev">▼</span>
        </summary>
        <div class="accBody">

          <div class="checkGrid">
            <div class="checkItem"><div class="checkRow">
              <input id="ab_bleed" class="ab" data-key="bleed" type="checkbox">
              <label class="checkText" for="ab_bleed">出血</label>
            </div></div>

            <div class="checkItem"><div class="checkRow">
              <input id="ab_stun" class="ab" data-key="stun" type="checkbox">
              <label class="checkText" for="ab_stun">スタン</label>
            </div></div>

            <div class="checkItem"><div class="checkRow">
              <input id="ab_poison" class="ab" data-key="poison" type="checkbox">
              <label class="checkText" for="ab_poison">中毒</label>
            </div></div>

            <div class="checkItem"><div class="checkRow">
              <input id="ab_burn" class="ab" data-key="burn" type="checkbox">
              <label class="checkText" for="ab_burn">火傷</label>
            </div></div>

            <div class="checkItem"><div class="checkRow">
              <input id="ab_slow" class="ab" data-key="slow" type="checkbox">
              <label class="checkText" for="ab_slow">移動速度減少（長文でも折り返しOK）</label>
            </div></div>

            <div class="checkItem"><div class="checkRow">
              <input id="ab_immune" class="ab" data-key="immune" type="checkbox">
              <label class="checkText" for="ab_immune">免疫（状態異常数に含めない / リスト表示もしない）</label>
            </div></div>
          </div>

          <div class="row" style="margin-top:12px;">
            <label>状態異常1つごとのダメージ（%）</label>
            <input id="abPer" type="number" value="" placeholder="未入力なら0" min="0" step="1">
          </div>

        </div>
      </details>

      <!-- 対象条件 Accordion（飛行チェック + 飛行追撃を内包） -->
      <details class="accordion" open>
        <summary>
          <span>対象条件</span>
          <span class="mini">飛行は状態異常数に含めない</span>
          <span class="chev">▼</span>
        </summary>
        <div class="accBody">

          <div class="checkGrid">
            <div class="checkItem"><div class="checkRow">
              <input id="cond_flying" class="cond" type="checkbox">
              <label class="checkText" for="cond_flying">飛行（対象）</label>
            </div></div>
          </div>

          <details id="acc_flying" class="innerDetails">
            <summary><span>飛行追撃 <span class="badge">各種</span></span><span>条件: 飛行（対象）</span></summary>
            <div class="dimNote">飛行（対象）がOFFのため不適用（半透明・操作不可）</div>
            <div class="stack" id="list_flying"></div>
            <div class="btnRow"><button type="button" data-add="flying">追加</button><button type="button" data-clear="flying">全削除</button></div>
          </details>

        </div>
      </details>

      <!-- 追撃（状態異常）まとめ -->
      <details class="accordion" open>
        <summary>
          <span>追撃（状態異常）</span>
          <span class="mini">条件OFF時は半透明・操作不可</span>
          <span class="chev">▼</span>
        </summary>
        <div class="accBody">

          <details id="acc_stun" class="innerDetails">
            <summary><span>スタン追撃 <span class="badge">各種</span></span><span>条件: スタン</span></summary>
            <div class="dimNote">スタンがOFFのため不適用（半透明・操作不可）</div>
            <div class="stack" id="list_stun"></div>
            <div class="btnRow"><button type="button" data-add="stun">追加</button><button type="button" data-clear="stun">全削除</button></div>
          </details>

          <details id="acc_slow" class="innerDetails">
            <summary><span>スロー追撃 <span class="badge">各種</span></span><span>条件: 移動速度減少</span></summary>
            <div class="dimNote">移動速度減少がOFFのため不適用（半透明・操作不可）</div>
            <div class="stack" id="list_slow"></div>
            <div class="btnRow"><button type="button" data-add="slow">追加</button><button type="button" data-clear="slow">全削除</button></div>
          </details>

          <details id="acc_bleed" class="innerDetails">
            <summary><span>出血追撃 <span class="badge">各種</span></span><span>条件: 出血</span></summary>
            <div class="dimNote">出血がOFFのため不適用（半透明・操作不可）</div>
            <div class="stack" id="list_bleed"></div>
            <div class="btnRow"><button type="button" data-add="bleed">追加</button><button type="button" data-clear="bleed">全削除</button></div>
          </details>

          <details id="acc_poison" class="innerDetails">
            <summary><span>中毒追撃 <span class="badge">各種</span></span><span>条件: 中毒</span></summary>
            <div class="dimNote">中毒がOFFのため不適用（半透明・操作不可）</div>
            <div class="stack" id="list_poison"></div>
            <div class="btnRow"><button type="button" data-add="poison">追加</button><button type="button" data-clear="poison">全削除</button></div>
          </details>

          <details id="acc_burn" class="innerDetails">
            <summary><span>火傷追撃 <span class="badge">各種</span></span><span>条件: 火傷</span></summary>
            <div class="dimNote">火傷がOFFのため不適用（半透明・操作不可）</div>
            <div class="stack" id="list_burn"></div>
            <div class="btnRow"><button type="button" data-add="burn">追加</button><button type="button" data-clear="burn">全削除</button></div>
          </details>

          <details id="acc_immune" class="innerDetails">
            <summary><span>免疫追撃 <span class="badge">各種</span></span><span>条件: 免疫</span></summary>
            <div class="dimNote">免疫がOFFのため不適用（半透明・操作不可）</div>
            <div class="stack" id="list_immune"></div>
            <div class="btnRow"><button type="button" data-add="immune">追加</button><button type="button" data-clear="immune">全削除</button></div>
          </details>

        </div>
      </details>

    </div>

    <div class="card">

      <!-- ★ 表示形式（単位あり/なし/両方） -->
      <div class="row" style="margin-top:0;">
        <label>表示形式（ダメージ/ATKなど）</label>
        <select id="numFormat">
          <option value="plain">単位なし（カンマ）</option>
          <option value="unit">単位あり（K/M/B/T/Qa/Qi）</option>
          <option value="both">両方（カンマ + 単位）</option>
        </select>
      </div>

      <div class="kpi">
        <div class="box">
          <div class="small">基本1発（通常 / 非クリ）</div>
          <div id="outBaseNormal" class="mono v">-</div>
        </div>
        <div class="box">
          <div class="small">基本1発（クリティカル）</div>
          <div id="outBaseCrit" class="mono v">-</div>
        </div>

        <div class="box">
          <div class="small">平均1発（CR考慮）</div>
          <div id="outBaseExp" class="mono v">-</div>
          <div id="noteBaseExp" class="note" style="display:none;"></div>
        </div>

        <div class="box">
          <div class="small">状態異常数（免疫除外）</div>
          <div id="outAbCount" class="mono v">-</div>
          <div id="outAbList" class="small mono">-</div>
        </div>

        <div class="box">
          <div class="small">最終1発（通常 / 非クリ）</div>
          <div id="outFinalNormal" class="mono v">-</div>
        </div>
        <div class="box">
          <div class="small">最終1発（クリティカル）</div>
          <div id="outFinalCrit" class="mono v">-</div>
        </div>

        <div class="box" style="grid-column:1/-1;">
          <div class="small">最終 平均1発（CR考慮）</div>
          <div id="outFinalExp" class="mono v">-</div>
          <div id="noteFinalExp" class="note" style="display:none;"></div>
        </div>
      </div>

      <details open>
        <summary>最終式ツリー</summary>

        <div class="seg">
          <button type="button" id="btnTreeColor" class="active">色付き（見やすい）</button>
          <button type="button" id="btnTreeText">純テキスト（コピー向け）</button>
        </div>

        <div class="copyRow">
          <button type="button" id="btnCopyTree">ツリーをコピー</button>
          <button type="button" id="btnClearSave">保存データを消す</button>
        </div>
        <div id="copyToast" class="toast" style="display:none;">コピーしました</div>

        <pre id="treeColor"></pre>
        <pre id="treeText" style="display:none;"></pre>
      </details>

      <details>
        <summary>内部データ</summary>
        <pre id="debug"></pre>
      </details>
    </div>
  </div>
</div>

<script>
function $(id){ return document.getElementById(id); }
function $$(q){ return Array.prototype.slice.call(document.querySelectorAll(q)); }

/* ----------------------------
   Number Format (plain / unit / both)
   ※ unit のときは小数2桁固定
---------------------------- */
function fmtPlain(n){
  if(!isFinite(n)) return "-";
  return Math.round(n).toLocaleString("ja-JP");
}

function fmtFixed2(x){
  if(!isFinite(x)) return "-";
  return Number(x).toFixed(2);
}

function fmtUnit(n){
  if(!isFinite(n)) return "-";
  var sign = n < 0 ? "-" : "";
  var a = Math.abs(n);

  if(a < 1000){
    return sign + fmtFixed2(a);
  }

  // 1e18 は Qi に統一して表示（入力は Qi/E どちらでも可）
  var units = [
    {u:"Qi", v:1e18},
    {u:"Qa", v:1e15},
    {u:"T",  v:1e12},
    {u:"B",  v:1e9},
    {u:"M",  v:1e6},
    {u:"K",  v:1e3}
  ];

  var pick = units[units.length - 1];
  for(var i=0;i<units.length;i++){
    if(a >= units[i].v){
      pick = units[i];
      break;
    }
  }

  var x = a / pick.v;
  return sign + fmtFixed2(x) + pick.u;
}

function fmtNum(n){
  var mode = ($("numFormat") && $("numFormat").value) ? $("numFormat").value : "plain";
  if(mode === "unit") return fmtUnit(n);
  if(mode === "both"){
    if(!isFinite(n)) return "-";
    return fmtPlain(n) + " (" + fmtUnit(n) + ")";
  }
  return fmtPlain(n);
}

function escapeHtml(s){
  s = String(s);
  s = s.replace(/&/g,"&amp;");
  s = s.replace(/</g,"&lt;");
  s = s.replace(/>/g,"&gt;");
  s = s.replace(/"/g,"&quot;");
  s = s.replace(/'/g,"&#39;");
  return s;
}

function trimZero4(x){
  var s = String(x.toFixed(4));
  s = s.replace(/0+$/,"").replace(/\.$/,"");
  return s;
}

/* 単位: K/M/B/T/Qa/Qi/E (ATK入力用) */
function unitLabelFromMult(mult){
  if(mult===1) return "";
  if(mult===1e3) return "K";
  if(mult===1e6) return "M";
  if(mult===1e9) return "B";
  if(mult===1e12) return "T";
  if(mult===1e15) return "Qa";
  if(mult===1e18) return "Qi/E";
  return "x"+String(mult);
}
function parseUnitMult(v){
  var m = Number(v);
  if(!isFinite(m) || m<=0) m = 1;
  return m;
}

function makeRow(kind, name, pct){
  if(typeof name === "undefined") name = "";
  if(typeof pct === "undefined") pct = "";
  var row = document.createElement("div");
  row.className = "entryItem";
  row.innerHTML =
    '<input type="text" class="entryName" placeholder="名称（例：装備 / マウント / 武器 など）" value="'+ escapeHtml(name) +'">' +
    '<input type="number" class="entryPct" min="0" step="1" value="'+ (pct === "" ? "" : escapeHtml(String(pct))) +'" placeholder="未入力なら0">' +
    '<button type="button" class="btnDel">削除</button>';

  row.querySelector(".btnDel").addEventListener("click", function(){ row.remove(); calc(); });
  row.querySelector(".entryName").addEventListener("input", calc);
  row.querySelector(".entryPct").addEventListener("input", calc);
  return row;
}

function listEntries(kind){
  var host = $("list_"+kind);
  if(!host) return [];
  var rows = host.querySelectorAll(".entryItem");
  var out = [];
  for(var i=0;i<rows.length;i++){
    var r = rows[i];
    var nameEl = r.querySelector(".entryName");
    var pctEl  = r.querySelector(".entryPct");
    var name = (nameEl && nameEl.value) ? nameEl.value.trim() : "";
    var pctRaw = (pctEl && typeof pctEl.value !== "undefined") ? pctEl.value : "";
    var pct = Number((pctRaw === "" ? 0 : pctRaw) || 0);
    pct = Math.max(0, pct);
    if(name !== "" || pct !== 0) out.push({name:name, pct:pct});
  }
  return out;
}
function sumPct(entries){
  var a = 0;
  for(var i=0;i<entries.length;i++) a += (Number(entries[i].pct)||0);
  return a;
}

function abLabel(key){
  // 表示用（KPIのリストを日本語に）
  if(key==="bleed") return "出血";
  if(key==="stun") return "スタン";
  if(key==="poison") return "中毒";
  if(key==="burn") return "火傷";
  if(key==="slow") return "移動速度減少";
  if(key==="immune") return "免疫";
  return key;
}

function getAbnormal(){
  var checked = [];
  var abs = $$("input.ab");
  for(var i=0;i<abs.length;i++){
    if(abs[i].checked) checked.push(abs[i].getAttribute("data-key"));
  }
  var count = 0;
  var listed = [];
  for(var j=0;j<checked.length;j++){
    // 免疫は「状態異常数」に含めない、かつリストにも出さない
    if(checked[j] !== "immune"){
      count++;
      listed.push(abLabel(checked[j]));
    }
  }
  return { checked:checked, count:count, listed:listed };
}

function setDimAndDisable(accId, isActive){
  var d = $(accId);
  if(!d) return;
  if(!isActive){
    d.classList.add("isDim");
    d.classList.add("isDisabled");
    d.open = false;
  }else{
    d.classList.remove("isDim");
    d.classList.remove("isDisabled");
  }
}

function treeLineHtml(cls, s){ return '<span class="'+cls+'">'+ escapeHtml(s) +'</span><br>'; }
function treeLineText(s){ return s + "\n"; }

function copyTextToClipboard(text){
  if(navigator.clipboard && navigator.clipboard.writeText){
    return navigator.clipboard.writeText(text).then(function(){ return true; }).catch(function(){ return false; });
  }
  try{
    var ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    return Promise.resolve(true);
  }catch(e){
    return Promise.resolve(false);
  }
}

function setTreeMode(mode){
  window.__TREE_MODE__ = mode;
  var isColor = (mode === "color");
  $("btnTreeColor").classList.toggle("active", isColor);
  $("btnTreeText").classList.toggle("active", !isColor);
  $("treeColor").style.display = isColor ? "" : "none";
  $("treeText").style.display  = isColor ? "none" : "";
  scheduleSave();
}

/* ----------------------------
   LocalStorage Auto Save / Load
---------------------------- */
var STORAGE_KEY = "underdark_damage_calc_tree_v1";
var _saveTimer = null;

function scheduleSave(){
  if(_saveTimer) clearTimeout(_saveTimer);
  _saveTimer = setTimeout(function(){
    _saveTimer = null;
    saveState();
  }, 250);
}

function saveState(){
  try{
    var state = { v: 1, t: Date.now(), inputs: {}, lists: {}, treeMode: (window.__TREE_MODE__||"color") };

    var nodes = $$("input[id], select[id], textarea[id]");
    for(var i=0;i<nodes.length;i++){
      var el = nodes[i];
      var id = el.id;
      if(!id) continue;
      var tag = (el.tagName||"").toLowerCase();
      var type = (el.getAttribute("type")||"").toLowerCase();
      if(tag==="input" && (type==="checkbox" || type==="radio")){
        state.inputs[id] = {t:"c", v: !!el.checked};
      }else{
        state.inputs[id] = {t:"v", v: (typeof el.value!=="undefined" ? el.value : "")};
      }
    }

    var kinds = ["stun","slow","bleed","poison","burn","immune","flying"];
    for(var k=0;k<kinds.length;k++){
      var kind = kinds[k];
      state.lists[kind] = listEntries(kind);
    }

    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }catch(e){}
}

function loadState(){
  try{
    var raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    var state = JSON.parse(raw);
    if(!state || !state.inputs) return;

    if(state.treeMode) window.__TREE_MODE__ = state.treeMode;

    for(var id in state.inputs){
      if(!Object.prototype.hasOwnProperty.call(state.inputs, id)) continue;
      var item = state.inputs[id];
      var el = $(id);
      if(!el) continue;
      if(item.t==="c"){
        el.checked = !!item.v;
      }else{
        el.value = (item.v==null ? "" : String(item.v));
      }
    }

    if(state.lists){
      for(var kind in state.lists){
        if(!Object.prototype.hasOwnProperty.call(state.lists, kind)) continue;
        var host = $("list_"+kind);
        if(!host) continue;
        host.innerHTML = "";
        var arr = state.lists[kind] || [];
        for(var i=0;i<arr.length;i++){
          host.appendChild(makeRow(kind, arr[i].name || "", Number(arr[i].pct || 0)));
        }
      }
    }
  }catch(e){}
}

function clearSaved(){
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
}

/* ----------------------------
   Notes for Expected (CR)
---------------------------- */
function setExpectedNotes(cr01){
  var b = $("noteBaseExp");
  var f = $("noteFinalExp");
  if(!b || !f) return;

  var show = false;
  var txt = "";

  var near0 = (Math.abs(cr01 - 0) < 1e-12);
  var near1 = (Math.abs(cr01 - 1) < 1e-12);

  if(near1){
    show = true;
    txt = "※ CR=100% のため、平均 = クリティカルと同じ";
  }else if(near0){
    show = true;
    txt = "※ CR=0% のため、平均 = 通常（非クリ）と同じ";
  }else{
    show = false;
  }

  b.style.display = show ? "" : "none";
  f.style.display = show ? "" : "none";
  b.textContent = txt;
  f.textContent = txt;
}

/* ----------------------------
   Main Calc
---------------------------- */
function calc(){
  var heroKey = ($("heroSelect").value || "");
  var heroLevelRaw = ($("heroLevel").value || "");

  var atkRaw = $("atk").value;
  var atkUnitRaw = $("atkUnit").value;

  var heroAtk50CountRaw = $("heroAtk50Count").value;
  var crRaw  = $("cr").value;
  var cdRaw  = $("cd").value;
  var monRaw = $("monDmg").value;
  var abPerRaw = $("abPer").value;

  var pickCountRaw = $("pickCount").value;
  var pickPctRaw   = $("pickPct").value;

  var atkInput = Math.max(0, Number((atkRaw === "" ? 0 : atkRaw) || 0));
  var atkUnitMult = parseUnitMult(atkUnitRaw);
  var atkUnitLabel = unitLabelFromMult(atkUnitMult);

  var atk = atkInput * atkUnitMult;

  var heroAtk50Count = Math.max(0, Math.floor(Number((heroAtk50CountRaw === "" ? 0 : heroAtk50CountRaw) || 0)));
  var heroAtkMult = 1 + (0.5 * heroAtk50Count);

  var cr  = Math.min(100, Math.max(0, Number((crRaw === "" ? 0 : crRaw) || 0))) / 100;
  var cd  = Math.max(0, Number((cdRaw === "" ? 0 : cdRaw) || 0)) / 100;

  var monDmgPct = Math.max(0, Number((monRaw === "" ? 0 : monRaw) || 0));
  var monDmgMult = 1 + (monDmgPct / 100);

  var pickCount = Math.max(0, Math.floor(Number((pickCountRaw === "" ? 0 : pickCountRaw) || 0)));
  var pickPctPer = Math.max(0, Number((pickPctRaw === "" ? 0 : pickPctRaw) || 0));
  var pickMult = 1 + (pickCount * (pickPctPer / 100));

  var atkEff = atk * heroAtkMult * pickMult;

  var baseNormal = atkEff;
  var baseCrit   = atkEff * (1 + cd);
  var baseAvg    = baseNormal * (1 - cr) + baseCrit * cr;

  var abPerPct = Math.max(0, Number((abPerRaw === "" ? 0 : abPerRaw) || 0));
  var ab = getAbnormal();
  var abMult = 1 + ab.count * (abPerPct / 100);

  var apply = {
    stun:  ab.checked.indexOf("stun") >= 0,
    slow:  ab.checked.indexOf("slow") >= 0,
    bleed: ab.checked.indexOf("bleed") >= 0,
    poison:ab.checked.indexOf("poison") >= 0,
    burn:  ab.checked.indexOf("burn") >= 0,
    immune:ab.checked.indexOf("immune") >= 0,
    flying: $("cond_flying").checked
  };

  setDimAndDisable("acc_stun", apply.stun);
  setDimAndDisable("acc_slow", apply.slow);
  setDimAndDisable("acc_bleed", apply.bleed);
  setDimAndDisable("acc_poison", apply.poison);
  setDimAndDisable("acc_burn", apply.burn);
  setDimAndDisable("acc_immune", apply.immune);
  setDimAndDisable("acc_flying", apply.flying);

  var kinds = ["stun","slow","bleed","poison","burn","immune","flying"];
  var sums = {};
  var mults = {};
  var used = {};
  var entries = {};

  for(var i=0;i<kinds.length;i++){
    var k = kinds[i];
    entries[k] = listEntries(k);
    sums[k] = sumPct(entries[k]);
    mults[k] = 1 + Math.max(0, sums[k]) / 100;
    used[k] = apply[k] ? mults[k] : 1;
  }

  var factorAll =
    monDmgMult * abMult *
    used.stun * used.slow * used.bleed * used.poison * used.burn *
    used.immune * used.flying;

  var finalNormal = baseNormal * factorAll;
  var finalCrit   = baseCrit   * factorAll;
  var finalAvg    = baseAvg    * factorAll;

  $("outBaseNormal").textContent = fmtNum(baseNormal);
  $("outBaseCrit").textContent   = fmtNum(baseCrit);
  $("outBaseExp").textContent    = fmtNum(baseAvg);

  $("outAbCount").textContent = String(ab.count);
  $("outAbList").textContent = (ab.listed.length ? ab.listed.join(" / ") : "(なし)");

  $("outFinalNormal").textContent = fmtNum(finalNormal);
  $("outFinalCrit").textContent   = fmtNum(finalCrit);
  $("outFinalExp").textContent    = fmtNum(finalAvg);

  setExpectedNotes(cr);

  var tHtml = "";
  var tText = "";

  tHtml += treeLineHtml("t-base", "Final（平均） = Base（平均/CR考慮） × MonsterTaken × Abnormal × (追撃各種...)");
  tHtml += treeLineHtml("t-base", "Final（通常/クリ）も同じ係数（FactorAll）を掛けたもの");
  tHtml += treeLineHtml("t-base", "");
  tText += treeLineText("Final（平均） = Base（平均/CR考慮） × MonsterTaken × Abnormal × (追撃各種...)");
  tText += treeLineText("Final（通常/クリ）も同じ係数（FactorAll）を掛けたもの");
  tText += treeLineText("");

  tHtml += treeLineHtml("t-base", "Hero（表示用）");
  tHtml += treeLineHtml("t-base", "├─ hero = " + (heroKey ? heroKey : "(未選択)"));
  tHtml += treeLineHtml("t-base", "└─ level = " + (heroLevelRaw ? heroLevelRaw : "(未選択)"));
  tHtml += treeLineHtml("t-base", "");
  tText += treeLineText("Hero（表示用）");
  tText += treeLineText("├─ hero = " + (heroKey ? heroKey : "(未選択)"));
  tText += treeLineText("└─ level = " + (heroLevelRaw ? heroLevelRaw : "(未選択)"));
  tText += treeLineText("");

  tHtml += treeLineHtml("t-heroatk", "HeroATK +50% × 回数（ATKに乗算）");
  tHtml += treeLineHtml("t-heroatk", "├─ count = " + heroAtk50Count);
  tHtml += treeLineHtml("t-heroatk", "└─ HeroATKMult = 1 + 0.5×count = " + trimZero4(heroAtkMult) + "x");
  tHtml += treeLineHtml("t-base", "");
  tText += treeLineText("HeroATK +50% × 回数（ATKに乗算）");
  tText += treeLineText("├─ count = " + heroAtk50Count);
  tText += treeLineText("└─ HeroATKMult = 1 + 0.5×count = " + trimZero4(heroAtkMult) + "x");
  tText += treeLineText("");

  tHtml += treeLineHtml("t-pick", "Pickaxe（ツルハシATK増加）");
  tHtml += treeLineHtml("t-pick", "├─ count = " + pickCount);
  tHtml += treeLineHtml("t-pick", "├─ per = " + pickPctPer + "% / 本");
  tHtml += treeLineHtml("t-pick", "└─ PickaxeMult = 1 + count×per/100 = " + trimZero4(pickMult) + "x");
  tHtml += treeLineHtml("t-base", "");
  tText += treeLineText("Pickaxe（ツルハシATK増加）");
  tText += treeLineText("├─ count = " + pickCount);
  tText += treeLineText("├─ per = " + pickPctPer + "% / 本");
  tText += treeLineText("└─ PickaxeMult = 1 + count×per/100 = " + trimZero4(pickMult) + "x");
  tText += treeLineText("");

  tHtml += treeLineHtml("t-base", "Base（通常/クリ/平均）");
  tHtml += treeLineHtml("t-base", "├─ ATK(input): " + String(atkInput) + (atkUnitLabel ? " " + atkUnitLabel : ""));
  tHtml += treeLineHtml("t-base", "├─ ATK(abs): " + fmtNum(atk));
  tHtml += treeLineHtml("t-heroatk", "├─ HeroATKMult: " + trimZero4(heroAtkMult) + "x");
  tHtml += treeLineHtml("t-pick", "├─ PickaxeMult: " + trimZero4(pickMult) + "x");
  tHtml += treeLineHtml("t-base", "├─ ATK(eff): " + fmtNum(atkEff));
  tHtml += treeLineHtml("t-base", "├─ CR: " + (cr*100).toFixed(1) + "% / CD: " + (cd*100).toFixed(1) + "%");
  tHtml += treeLineHtml("t-base", "├─ Base(通常) = ATK(eff) = " + fmtNum(baseNormal));
  tHtml += treeLineHtml("t-base", "├─ Base(クリ) = ATK(eff)×(1+CD) = " + fmtNum(baseCrit));
  tHtml += treeLineHtml("t-base", "└─ Base(平均) = 通常×(1-CR) + クリ×CR = " + fmtNum(baseAvg));
  tHtml += treeLineHtml("t-base", "");

  tText += treeLineText("Base（通常/クリ/平均）");
  tText += treeLineText("├─ ATK(input): " + String(atkInput) + (atkUnitLabel ? " " + atkUnitLabel : ""));
  tText += treeLineText("├─ ATK(abs): " + fmtNum(atk));
  tText += treeLineText("├─ HeroATKMult: " + trimZero4(heroAtkMult) + "x");
  tText += treeLineText("├─ PickaxeMult: " + trimZero4(pickMult) + "x");
  tText += treeLineText("├─ ATK(eff): " + fmtNum(atkEff));
  tText += treeLineText("├─ CR: " + (cr*100).toFixed(1) + "% / CD: " + (cd*100).toFixed(1) + "%");
  tText += treeLineText("├─ Base(通常) = ATK(eff) = " + fmtNum(baseNormal));
  tText += treeLineText("├─ Base(クリ) = ATK(eff)×(1+CD) = " + fmtNum(baseCrit));
  tText += treeLineText("└─ Base(平均) = 通常×(1-CR) + クリ×CR = " + fmtNum(baseAvg));
  tText += treeLineText("");

  tHtml += treeLineHtml("t-base", "Final（通常/クリ/平均）");
  tHtml += treeLineHtml("t-base", "├─ FactorAll = MonsterTaken×Abnormal×追撃... = " + trimZero4(factorAll) + "x");
  tHtml += treeLineHtml("t-base", "├─ Final(通常) = Base(通常)×FactorAll = " + fmtNum(finalNormal));
  tHtml += treeLineHtml("t-base", "├─ Final(クリ) = Base(クリ)×FactorAll = " + fmtNum(finalCrit));
  tHtml += treeLineHtml("t-base", "└─ Final(平均) = Base(平均)×FactorAll = " + fmtNum(finalAvg));

  tText += treeLineText("Final（通常/クリ/平均）");
  tText += treeLineText("├─ FactorAll = MonsterTaken×Abnormal×追撃... = " + trimZero4(factorAll) + "x");
  tText += treeLineText("├─ Final(通常) = Base(通常)×FactorAll = " + fmtNum(finalNormal));
  tText += treeLineText("├─ Final(クリ) = Base(クリ)×FactorAll = " + fmtNum(finalCrit));
  tText += treeLineText("└─ Final(平均) = Base(平均)×FactorAll = " + fmtNum(finalAvg));

  $("treeColor").innerHTML = tHtml;
  $("treeText").textContent = tText;

  $("debug").textContent = JSON.stringify({
    display: { numFormat: ($("numFormat").value || "plain") },
    hero: { key: heroKey, level: heroLevelRaw },
    atkInput: { value: atkInput, unitMult: atkUnitMult, unitLabel: atkUnitLabel, abs: atk },
    base: {
      heroAtk50Count: heroAtk50Count,
      heroAtkMult: heroAtkMult,
      atkEff:atkEff,
      pickCount:pickCount,
      pickPctPer:pickPctPer,
      pickMult:pickMult,
      cr:cr,
      cd:cd,
      baseNormal: baseNormal,
      baseCrit: baseCrit,
      baseAvg: baseAvg
    },
    monsterTaken: { pct: monDmgPct, mult: monDmgMult },
    abnormal: { checked: ab.checked, listed: ab.listed, count: ab.count, perPct: abPerPct, mult: abMult },
    apply: apply,
    sums: sums,
    mults: mults,
    used: used,
    factorAll: factorAll,
    finalNormal: finalNormal,
    finalCrit: finalCrit,
    finalAvg: finalAvg
  }, null, 2);

  scheduleSave();
}

/* ----------------------------
   UI wiring
---------------------------- */
function wireButtons(){
  var addBtns = $$('button[data-add]');
  for(var i=0;i<addBtns.length;i++){
    (function(btn){
      btn.addEventListener("click", function(){
        var kind = btn.getAttribute("data-add");
        var host = $("list_"+kind);
        if(!host) return;
        host.appendChild(makeRow(kind, "", ""));
        var det = $("acc_"+kind);
        if(det) det.open = true;
        calc();
      });
    })(addBtns[i]);
  }

  var clearBtns = $$('button[data-clear]');
  for(var j=0;j<clearBtns.length;j++){
    (function(btn){
      btn.addEventListener("click", function(){
        var kind = btn.getAttribute("data-clear");
        var host = $("list_"+kind);
        if(!host) return;
        host.innerHTML = "";
        calc();
      });
    })(clearBtns[j]);
  }
}

function wireTreeUI(){
  $("btnTreeColor").addEventListener("click", function(){ setTreeMode("color"); });
  $("btnTreeText").addEventListener("click", function(){ setTreeMode("text"); });

  $("btnCopyTree").addEventListener("click", function(){
    var txt = $("treeText").textContent || "";
    copyTextToClipboard(txt).then(function(ok){
      var toast = $("copyToast");
      toast.style.display = "";
      toast.textContent = ok ? "コピーしました（純テキスト）" : "コピーに失敗しました";
      setTimeout(function(){ toast.style.display="none"; }, 1200);
    });
  });

  $("btnClearSave").addEventListener("click", function(){
    clearSaved();
    var toast = $("copyToast");
    toast.style.display = "";
    toast.textContent = "保存データを削除しました";
    setTimeout(function(){ toast.style.display="none"; }, 1200);
  });
}

/* Tooltip (tap open/close on mobile) */
function wireTooltips(){
  var tips = $$(".tip");
  for(var i=0;i<tips.length;i++){
    (function(t){
      t.addEventListener("click", function(e){
        e.stopPropagation();
        var opened = $$(".tip.isOpen");
        for(var k=0;k<opened.length;k++){
          if(opened[k] !== t) opened[k].classList.remove("isOpen");
        }
        t.classList.toggle("isOpen");
      });
    })(tips[i]);
  }

  document.addEventListener("click", function(){
    var opened = $$(".tip.isOpen");
    for(var i=0;i<opened.length;i++) opened[i].classList.remove("isOpen");
  });

  document.addEventListener("keydown", function(e){
    if(e.key === "Escape"){
      var opened = $$(".tip.isOpen");
      for(var i=0;i<opened.length;i++) opened[i].classList.remove("isOpen");
    }
  });
}

/* input listeners */
["atk","atkUnit","heroAtk50Count","cr","cd","monDmg","pickCount","pickPct","abPer","numFormat"].forEach(function(id){
  $(id).addEventListener("input", calc);
  $(id).addEventListener("change", calc);
});
["heroSelect","heroLevel"].forEach(function(id){
  $(id).addEventListener("change", calc);
});
$$("input.ab").forEach(function(x){ x.addEventListener("change", calc); });
$("cond_flying").addEventListener("change", calc);

// save on tab close
window.addEventListener("pagehide", function(){ saveState(); });

wireButtons();
wireTreeUI();
wireTooltips();
loadState();
setTreeMode(window.__TREE_MODE__||"color");
calc();
</script>
</body>
</html>
